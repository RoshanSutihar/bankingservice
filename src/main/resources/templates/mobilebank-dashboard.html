<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Banking Dashboard</title>

    <!-- Bootstrap & Font Awesome (keeping these as you had them) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        /* Custom QR scanner styles - keeping yours */
        .qr-scanner {
            width: 100%;
            max-width: 300px;
            height: 250px;
            border: 2px solid #4361ee;
            border-radius: 15px;
        }

        /* Smooth transitions */
        .smooth-transition {
            transition: all 0.3s ease;
        }

        /* Custom colors to match your theme */
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --warning: #ffc107;
        }
    </style>
</head>
<body class="bg-gray-50">
<!-- Navbar - Improved with Tailwind -->
<nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <i class="fas fa-mobile-alt me-2"></i>
            <span class="fw-bold">Mobile Banking</span>
        </a>
        <div class="navbar-nav ms-auto align-items-center">
            <span class="navbar-text me-3 fw-medium text-white" th:text="${user.username}">User</span>
            <a class="nav-link text-white hover:text-gray-200 smooth-transition" th:href="@{/logout}">
                <i class="fas fa-sign-out-alt"></i>
            </a>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container-fluid py-3 px-4">
    <!-- Desktop Tabs -->
    <ul class="nav nav-tabs d-none d-md-flex mb-0" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-medium px-4 py-3" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab">
                <i class="fas fa-credit-card me-2"></i>Account Info
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-medium px-4 py-3" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
                <i class="fas fa-history me-2"></i>Transaction History
            </button>
        </li>
    </ul>

    <div class="tab-content bg-white rounded-lg rounded-t-none md:rounded-t-lg shadow-lg" id="dashboardTabContent">
        <!-- Account Tab -->
        <div class="tab-pane fade show active p-4 md:p-6" id="account" role="tabpanel">
            <!-- QR Scan Button -->
            <div class="mb-6 text-center">
                <button id="scan-qr-desktop" class="btn btn-lg d-none d-md-inline-flex align-items-center"
                        style="background: linear-gradient(135deg, var(--success), #0ea5e9); border: none;">
                    <i class="fas fa-qrcode me-2"></i>Scan QR for Payment
                </button>
            </div>

            <!-- Account Cards -->
            <div class="row">
                <div class="col-12 mb-4" th:each="account : ${accounts}">
                    <div class="card border-0 shadow-lg rounded-2xl overflow-hidden">
                        <div class="card-body p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h5 class="card-title text-xl font-bold text-gray-800 mb-1" th:text="${account.accountType.typeName}">
                                        Account Type
                                    </h5>
                                    <p class="text-gray-600 mb-0">
                                        <span class="font-medium">Account Number:</span>
                                        <span th:text="${account.accountNumber}" class="font-mono">1234567890</span>
                                    </p>
                                </div>
                                <div class="bg-blue-50 text-blue-700 rounded-full p-3">
                                    <i class="fas fa-university text-xl"></i>
                                </div>
                            </div>

                            <div class="text-center my-6">
                                <p class="text-gray-500 text-sm mb-1">Current Balance</p>
                                <h2 class="text-4xl font-bold text-blue-700" th:text="'$' + ${#numbers.formatDecimal(account.currentBalance, 0, 2)}">
                                    $5,250.75
                                </h2>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 pt-6 border-t border-gray-100">
                                <div>
                                    <p class="text-gray-500 text-sm mb-1">Available Balance</p>
                                    <p class="text-xl font-semibold text-gray-800" th:text="'$' + ${#numbers.formatDecimal(account.availableBalance, 0, 2)}">
                                        $5,200.00
                                    </p>
                                </div>
                                <div class="text-right md:text-left">
                                    <p class="text-gray-500 text-sm mb-1">Routing Number</p>
                                    <p class="text-lg font-medium text-gray-800" th:text="${account.routingNumber}">
                                        021000021
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <h5 class="mt-6 mb-4 text-xl font-bold text-gray-800">Recent Transactions</h5>
            <div class="space-y-3">
                <div class="transaction-item border-b border-gray-100 last:border-b-0" th:each="txn : ${recentTransactions}">
                    <div class="p-4 hover:bg-gray-50 rounded-lg smooth-transition">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <div th:class="${txn.amount.signum() >= 0} ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                                     class="rounded-full p-3">
                                    <i th:class="${txn.amount.signum() >= 0} ? 'fas fa-arrow-down' : 'fas fa-arrow-up'"
                                       class="text-lg"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800 mb-1" th:text="${txn.description != null ? txn.description : 'Transaction'}">
                                        Description
                                    </p>
                                    <div class="flex items-center space-x-3">
                                        <small class="text-gray-500" th:text="${#temporals.format(txn.effectiveDate, 'MMM dd, yyyy')}">
                                            Date
                                        </small>
                                        <small th:if="${txn.transactionRef != null}"
                                               class="text-gray-400 text-xs bg-gray-100 px-2 py-1 rounded">
                                            Ref: <span th:text="${txn.transactionRef}">REF</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div th:text="${txn.amount.signum() >= 0} ? ('$' + ${#numbers.formatDecimal(txn.amount, 0, 2)}) : ('-$' + ${#numbers.formatDecimal(txn.amount.abs(), 0, 2)})"
                                     th:class="${txn.amount.signum() >= 0} ? 'text-green-600 font-bold text-lg' : 'text-red-600 font-bold text-lg'"
                                     class="font-bold">
                                    Amount
                                </div>
                                <div class="mt-1">
                                        <span th:if="${txn.status != null and txn.status.name() == 'PENDING'}"
                                              class="bg-yellow-100 text-yellow-800 text-xs font-semibold px-2 py-1 rounded-full">
                                            Pending
                                        </span>
                                    <span th:unless="${txn.status != null and txn.status.name() == 'PENDING'}"
                                          class="text-gray-500 text-xs">
                                            Completed
                                        </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div class="tab-pane fade p-4 md:p-6" id="transactions" role="tabpanel">
            <h5 class="mb-4 text-xl font-bold text-gray-800">Transaction History</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="text-gray-700 font-semibold py-3">Date</th>
                        <th class="text-gray-700 font-semibold py-3">Description</th>
                        <th class="text-gray-700 font-semibold py-3">Account</th>
                        <th class="text-gray-700 font-semibold py-3">Amount</th>
                        <th class="text-gray-700 font-semibold py-3">Type</th>
                        <th class="text-gray-700 font-semibold py-3">Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="txn : ${allTransactions}" class="hover:bg-gray-50 smooth-transition">
                        <td class="py-3 text-gray-800" th:text="${#temporals.format(txn.effectiveDate, 'MMM dd, yyyy HH:mm')}">
                            Date
                        </td>
                        <td class="py-3 text-gray-800" th:text="${txn.description != null ? txn.description : 'Transaction'}">
                            Description
                        </td>
                        <td class="py-3 text-gray-800" th:text="${txn.fromAccount != null ? txn.fromAccount.accountNumber : txn.toAccount.accountNumber}">
                            Account
                        </td>
                        <td class="py-3">
                                    <span th:text="${txn.amount.signum() >= 0} ? ('$' + ${#numbers.formatDecimal(txn.amount, 0, 2)}) : ('-$' + ${#numbers.formatDecimal(txn.amount.abs(), 0, 2)})"
                                          th:class="${txn.amount.signum() >= 0} ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold'"
                                          class="font-semibold">
                                        Amount
                                    </span>
                        </td>
                        <td class="py-3">
                                    <span th:text="${txn.amount.signum() >= 0} ? 'Credit' : 'Debit'"
                                          th:class="${txn.amount.signum() >= 0} ? 'text-green-600 bg-green-50 px-3 py-1 rounded-full text-sm' : 'text-red-600 bg-red-50 px-3 py-1 rounded-full text-sm'"
                                          class="font-medium">
                                        Type
                                    </span>
                        </td>
                        <td class="py-3">
                                    <span th:if="${txn.status != null and txn.status.name() == 'PENDING'}"
                                          class="bg-yellow-100 text-yellow-800 text-xs font-semibold px-3 py-1 rounded-full">
                                        Pending
                                    </span>
                            <span th:unless="${txn.status != null and txn.status.name() == 'PENDING'}"
                                  class="text-gray-500 text-sm">
                                        Completed
                                    </span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div th:if="${allTransactions.isEmpty()}" class="text-center py-12">
                <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
                <p class="text-gray-500">No transactions found.</p>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Bottom Navigation -->
<div class="d-md-none fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
    <div class="d-flex justify-content-around align-items-center h-16">
        <a href="#" class="bottom-nav-item text-decoration-none d-flex flex-column align-items-center text-primary" data-tab="account">
            <i class="fas fa-home fs-5 mb-1"></i>
            <small class="fw-medium">Home</small>
        </a>
        <a href="#" class="bottom-nav-item text-decoration-none d-flex flex-column align-items-center text-gray-600" data-tab="transactions">
            <i class="fas fa-history fs-5 mb-1"></i>
            <small class="fw-medium">History</small>
        </a>
    </div>
</div>

<!-- Floating QR Button (Mobile) -->
<button class="fab d-md-none" id="qrFab" title="Scan QR" style="background: linear-gradient(135deg, var(--success), #0ea5e9);">
    <i class="fas fa-qrcode"></i>
</button>

<!-- Toast Notification -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
    <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="toastMessage"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Scanner Modal - Original functionality preserved -->
<div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="scannerModalLabel">
                    <i class="fas fa-qrcode me-2"></i>Scan QR for Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex flex-column justify-content-center align-items-center">
                <div id="qr-reader-modal" class="qr-scanner mb-3"></div>
                <p id="qr-result-modal" class="text-muted mb-0">Point your camera at the QR code</p>
            </div>
        </div>
    </div>
</div>

<!-- Payment Confirm Modal - Original functionality preserved -->
<div class="modal fade" id="paymentConfirmModal" tabindex="-1" aria-labelledby="paymentConfirmLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentConfirmLabel">
                    <i class="fas fa-credit-card me-2"></i>Confirm Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="confirmDetails">
                    <p><strong>Merchant:</strong> <span id="confirmMerchant"></span></p>
                    <p><strong>Amount:</strong> <span id="confirmAmount"></span></p>
                    <p><strong>Account to Debit:</strong> <span id="confirmAccount"></span></p>
                    <small class="text-muted">This will debit your account and credit the merchant.</small>
                </div>
                <div id="confirmError" class="alert alert-danger mt-2" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmPaymentBtn" class="btn btn-success">Confirm Payment</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-body text-center p-4">
                <i class="fas fa-check-circle text-success mb-3" style="font-size: 4rem;"></i>
                <h4 class="text-success mb-2">Payment Successful!</h4>
                <p class="text-muted mb-0">Your payment has been processed successfully.</p>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Your Original JavaScript with QR Scanning Logic - PRESERVED -->
<script>
    let html5QrCode;
    const qrReaderModal = document.getElementById('qr-reader-modal');
    const qrResultModal = document.getElementById('qr-result-modal');
    const scannerModalInstance = new bootstrap.Modal(document.getElementById('scannerModal'), { backdrop: 'static', keyboard: false });
    const confirmModalInstance = new bootstrap.Modal(document.getElementById('paymentConfirmModal'));
    const successModalInstance = new bootstrap.Modal(document.getElementById('successModal'));
    const confirmDetails = document.getElementById('confirmDetails');
    const confirmError = document.getElementById('confirmError');
    const confirmMerchant = document.getElementById('confirmMerchant');
    const confirmAmount = document.getElementById('confirmAmount');
    const confirmAccount = document.getElementById('confirmAccount');
    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');

    function showError(msg) {
        const toastEl = document.getElementById('errorToast');
        const toastBody = document.getElementById('toastMessage');
        toastBody.innerHTML = msg;
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Mobile navigation
        document.querySelectorAll('.bottom-nav-item').forEach(item => {
            item.addEventListener('click', e => {
                e.preventDefault();
                document.querySelectorAll('.bottom-nav-item').forEach(i => {
                    i.classList.remove('text-primary');
                    i.classList.add('text-gray-600');
                });
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));

                item.classList.remove('text-gray-600');
                item.classList.add('text-primary');

                const targetTab = document.getElementById(item.dataset.tab);
                if (targetTab) {
                    targetTab.classList.add('show', 'active');
                    // Also activate the corresponding desktop tab button
                    const tabButton = document.querySelector(`[data-bs-target="#${item.dataset.tab}"]`);
                    if (tabButton) {
                        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(btn => btn.classList.remove('active'));
                        tabButton.classList.add('active');
                    }
                }
            });
        });

        // QR triggers
        const qrTriggers = [document.getElementById('qrFab'), document.getElementById('scan-qr-desktop')];
        qrTriggers.forEach(trigger => {
            if (trigger) {
                trigger.addEventListener('click', e => {
                    e.preventDefault();
                    startScanner();
                });
            }
        });

        // Scanner modal cleanup
        document.getElementById('scannerModal').addEventListener('hidden.bs.modal', stopScanning);
    });

    function checkSecureContext() {
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            showError('Camera access requires HTTPS. Switch to https:// and retry.');
            return false;
        }
        console.log('Secure context OK');
        return true;
    }

    async function startScanner() {
        if (typeof Html5Qrcode === 'undefined') {
            showError('QR scanner library failed to load');
            return;
        }
        if (!checkSecureContext()) return;

        html5QrCode = new Html5Qrcode("qr-reader-modal");
        qrResultModal.innerHTML = '<span class="text-primary"><i class="fas fa-spinner fa-spin me-1"></i>Starting camera...</span>';
        scannerModalInstance.show();

        try {
            const camerasPromise = Html5Qrcode.getCameras();
            const timeoutPromise = new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Camera request timed out')), 10000)
            );
            const cameras = await Promise.race([camerasPromise, timeoutPromise]);

            if (cameras.length === 0) {
                throw new Error('No cameras found');
            }

            let cameraId = cameras[0].id;
            const rearCamera = cameras.find(cam =>
                cam.label.toLowerCase().includes('back') || cam.label.toLowerCase().includes('rear') || cam.label.toLowerCase().includes('environment')
            );
            if (rearCamera) cameraId = rearCamera.id;

            const config = { fps: 5, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
            await html5QrCode.start(cameraId, config, onScanSuccess, onScanFailure);

            qrResultModal.innerHTML = '<span class="text-muted"><i class="fas fa-camera me-1"></i>Point at QR code</span>';

        } catch (err) {
            console.error('Scanner start error:', err);
            let errorMessage = `Failed: ${err.message || err.name}`;
            if (err.name === 'NotAllowedError') {
                errorMessage = 'Permission denied. Check browser settings and retry.';
            } else if (err.name === 'NotFoundError') {
                errorMessage = 'No camera detected.';
            } else if (err.message.includes('secure') || !window.isSecureContext) {
                errorMessage = 'HTTPS required for camera.';
            } else if (err.message.includes('timeout')) {
                errorMessage = 'Camera request timed outâ€”check connection.';
            }
            showError(errorMessage);
            scannerModalInstance.hide();
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log('QR Scan Success:', decodedText);
        stopScanning();
        scannerModalInstance.hide();
        processQRScan(decodedText);
    }

    function onScanFailure(error) {
        if (!error.includes('No QR code found')) {
            console.log('Scan error:', error);
        }
    }

    async function stopScanning() {
        try {
            if (html5QrCode && html5QrCode.isScanning) {
                await html5QrCode.stop();
                console.log('Scanner stopped');
            }
        } catch (err) {
            console.error('Stop error:', err);
        }
        qrResultModal.innerHTML = '<span class="text-muted"><i class="fas fa-camera me-1"></i>Point at QR code</span>';
    }

    async function processQRScan(qrData) {
        console.log('Processing QR scan with data:', qrData);
        showError('<i class="fas fa-spinner fa-spin me-1"></i>Validating payment...');

        try {
            // IMPORTANT: This is YOUR original API call - it will work with your backend
            const response = await fetch('/dashboard/api/validate-qr', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ qrData: qrData })
            });

            const validationResult = await response.json();
            console.log('Validation result:', validationResult);

            if (!validationResult.valid) {
                const errorMsg = validationResult.error || 'Invalid QR data';
                let displayMsg;
                if (errorMsg === 'No account found') {
                    displayMsg = 'No account available for payment. Please contact support.';
                } else if (errorMsg === 'Insufficient balance') {
                    const requiredAmt = validationResult.requiredAmount || 0;
                    displayMsg = `Insufficient balance. Required: $${requiredAmt.toFixed(2)}.`;
                } else {
                    displayMsg = errorMsg;
                }
                showError(displayMsg);
                return;
            }

            // Update confirmation modal with REAL data from your backend
            confirmMerchant.textContent = validationResult.merchantName || 'Unknown Merchant';
            confirmAmount.textContent = `$${validationResult.amount.toFixed(2)} ${validationResult.currency || 'USD'}`;
            confirmAccount.textContent = `****${validationResult.payerAccountNumber.slice(-4)}`;
            confirmError.style.display = 'none';
            confirmModalInstance.show();

            confirmPaymentBtn.onclick = async () => {
                confirmPaymentBtn.disabled = true;
                confirmPaymentBtn.textContent = 'Processing...';
                confirmError.style.display = 'none';

                try {
                    // IMPORTANT: This is YOUR original payment processing API call
                    const processResponse = await fetch('/dashboard/api/process-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            sessionId: validationResult.sessionId,
                            amount: validationResult.amount,
                            currency: validationResult.currency,
                            merchantId: validationResult.merchantId,
                            transactionRef: validationResult.transactionRef,
                            payerAccountId: validationResult.payerAccountId
                        })
                    });

                    const processResult = await processResponse.json();

                    if (!processResponse.ok || !processResult.success) {
                        throw new Error(processResult.error || `Payment failed: ${processResponse.statusText}`);
                    }

                    console.log('Payment result:', processResult);
                    confirmModalInstance.hide();
                    successModalInstance.show();
                    setTimeout(() => {
                        successModalInstance.hide();
                        location.reload();
                    }, 3000);
                } catch (err) {
                    console.error('Payment error:', err);
                    confirmError.textContent = err.message;
                    confirmError.style.display = 'block';
                } finally {
                    confirmPaymentBtn.disabled = false;
                    confirmPaymentBtn.textContent = 'Confirm Payment';
                }
            };

        } catch (err) {
            console.error('QR processing error:', err);
            showError(`Network error: ${err.message}`);
        }
    }

    window.addEventListener('beforeunload', stopScanning);
</script>
</body>
</html>