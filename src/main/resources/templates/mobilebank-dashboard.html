<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Mobile Banking Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --warning: #ffc107;
        }
        body {
            background-color: #f5f7ff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 80px;
        }
        .navbar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
        }
        .navbar-brand {
            font-weight: 600;
            font-size: 1.25rem;
        }
        .navbar-text {
            font-weight: 500;
        }
        .nav-tabs {
            margin-bottom: 0;
        }
        .nav-tabs .nav-link {
            border: none;
            color: var(--primary);
            font-weight: 500;
            padding: 1rem 1.5rem;
        }
        .nav-tabs .nav-link.active {
            background-color: var(--primary);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        .tab-content {
            background: white;
            border-radius: 0 0 20px 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .account-card {
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .account-card .card-body {
            padding: 1.5rem;
        }
        .card-title {
            color: var(--primary);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .card-text strong {
            color: var(--dark);
            font-weight: 600;
        }
        .balance {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 1rem 0 0.5rem 0;
            text-align: center;
        }
        .text-muted {
            font-size: 0.9rem;
            text-align: center;
            display: block;
        }
        .transaction-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 1rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-desc {
            flex: 1;
            margin-right: 1rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .transaction-desc .fw-bold {
            font-size: 0.95rem;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }
        .transaction-ref {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.125rem;
        }
        .transaction-amount-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-direction: column-reverse;
        }
        .transaction-amount {
            font-weight: 600;
            font-size: 1.1rem;
            min-width: 80px;
            text-align: right;
        }
        .status-pending {
            background-color: var(--warning) !important;
            color: #000 !important;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
        }
        .h5 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            #dashboardTabs {
                display: none !important;
            }
            body {
                padding-bottom: 100px;
            }
            .tab-content {
                padding: 1rem;
                margin-bottom: 0;
                border-radius: 20px 20px 0 0;
            }
            .account-card .card-body {
                padding: 1.25rem;
            }
            .balance {
                font-size: 2.2rem;
            }
            .transaction-ref {
                font-size: 0.7rem;
            }
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #dee2e6;
            z-index: 1030;
            display: none;
            flex-direction: row;
            justify-content: space-around;
            padding: 0.75rem 0;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #6c757d;
            text-decoration: none;
            padding: 0.5rem;
            font-size: 0.8rem;
            transition: color 0.2s;
        }
        .bottom-nav-item i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
        .bottom-nav-item.active {
            color: var(--primary);
        }
        .bottom-nav-item:hover {
            color: var(--primary);
        }

        .fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--success);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 6px 20px rgba(76, 201, 240, 0.4);
            z-index: 1040;
            display: none;
            transition: transform 0.2s;
        }
        .fab:hover {
            transform: scale(1.1);
            background: var(--secondary);
        }

        @media (max-width: 768px) {
            .bottom-nav {
                display: flex;
            }
            .fab {
                display: block;
            }
            .scan-qr-desktop {
                display: none;
            }
        }
        @media (min-width: 769px) {
            .scan-qr-desktop {
                display: block;
                width: 100%;
                padding: 1rem;
                border-radius: 12px;
                font-size: 1.1rem;
            }
        }

        .modal-fullscreen .modal-dialog {
            margin: 0;
            width: 100%;
            height: 100%;
            max-width: none;
        }
        .modal-fullscreen .modal-content {
            height: 100%;
            border: none;
            border-radius: 0;
        }
        .modal-fullscreen .modal-body {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .qr-scanner {
            width: 100%;
            max-width: 300px;
            height: 250px;
            border: 2px solid var(--primary);
            border-radius: 15px;
        }

        @media (max-width: 768px) {
            .transaction-table {
                font-size: 0.85rem;
            }
            .transaction-table th, .transaction-table td {
                padding: 0.5rem;
            }
        }

        .toast {
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .txn-id {
            font-family: monospace;
            font-size: 0.85rem;
            color: #6c757d;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <i class="fas fa-mobile-alt me-2"></i>Mobile Banking
        </a>
        <div class="navbar-nav ms-auto">
            <span class="navbar-text me-3" th:text="${user.username}">User</span>
            <a class="nav-link" href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </div>
</nav>


<div class="container-fluid py-3">
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab">
                <i class="fas fa-credit-card me-1"></i>Account Info
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
                <i class="fas fa-history me-1"></i>Transaction History
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="transfers-tab" data-bs-toggle="tab" data-bs-target="#transfers" type="button" role="tab">
                <i class="fas fa-exchange-alt me-1"></i>Transfers
            </button>
        </li>
    </ul>

    <div class="tab-content" id="dashboardTabContent">
        <div class="tab-pane fade show active" id="account" role="tabpanel">
            <div class="row">

                <div class="col-12 mb-4 text-center">
                    <button id="scan-qr-desktop" class="btn btn-success btn-lg scan-qr-desktop">
                        <i class="fas fa-qrcode me-2"></i>Scan QR for Payment
                    </button>
                </div>
                <div class="col-12" th:each="account : ${accounts}">
                    <div class="card account-card">
                        <div class="card-body">
                            <h5 class="card-title" th:text="${account.accountType.typeName}">Account Type</h5>
                            <p class="card-text">
                                <strong>Account Number:</strong> <span th:text="${account.accountNumber}"></span><br>
                                <strong>Routing Number:</strong> <span th:text="${account.routingNumber}"></span>
                            </p>
                            <div class="balance" th:text="'$' + ${#numbers.formatDecimal(account.currentBalance, 0, 2)}">Balance</div>
                            <small class="text-muted">Available: <span th:text="'$' + ${#numbers.formatDecimal(account.availableBalance, 0, 2)}"></span></small>
                        </div>
                    </div>
                </div>
            </div>
            <h5 class="mt-4">Recent Transactions</h5>
            <div class="list-group">
                <div class="list-group-item transaction-item" th:each="txn : ${recentTransactions}">
                    <div class="transaction-desc">
                        <div class="fw-bold" th:text="${txn.description != null ? txn.description : 'Transaction'}">Description</div>
                        <small class="text-muted" th:text="${#temporals.format(txn.effectiveDate, 'MMM dd, yyyy')}">Date</small>
                        <small class="transaction-ref" th:if="${txn.transactionRef != null}" th:text="'Ref: ' + ${txn.transactionRef}">Ref</small>
                    </div>
                    <div class="transaction-amount-container">
                        <div th:text="${txn.amount.signum() >= 0} ? ('$' + ${#numbers.formatDecimal(txn.amount, 0, 2)}) : ('-$' + ${#numbers.formatDecimal(txn.amount.abs(), 0, 2)})"
                             class="transaction-amount">Amount</div>
                        <span th:if="${txn.status != null and txn.status.name() == 'PENDING'}" class="badge status-pending">Pending</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="transactions" role="tabpanel">
            <h5>Transaction History</h5>
            <div class="table-responsive">
                <table class="transaction-table">
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Account</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Ref ID</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="txn : ${allTransactions}">
                        <td th:text="${#temporals.format(txn.effectiveDate, 'MMM dd, yyyy HH:mm')}">Date</td>
                        <td th:text="${txn.description != null ? txn.description : 'Transaction'}">Description</td>
                        <td th:text="${txn.fromAccount != null ? txn.fromAccount.accountNumber : txn.toAccount.accountNumber}">Account</td>
                        <td class="transaction-amount" th:text="${txn.amount.signum() >= 0} ? ('$' + ${#numbers.formatDecimal(txn.amount, 0, 2)}) : ('-$' + ${#numbers.formatDecimal(txn.amount.abs(), 0, 2)})">Amount</td>
                        <td th:text="${txn.amount.signum() >= 0} ? 'Credit' : 'Debit'">Type</td>
                        <td class="txn-id" th:text="${txn.transactionRef != null ? txn.transactionRef : txn.id}">Ref ID</td>
                        <td>
                            <span th:if="${txn.status != null and txn.status.name() == 'PENDING'}" class="badge status-pending">Pending</span>
                            <span th:unless="${txn.status != null and txn.status.name() == 'PENDING'}" class="text-muted small">Completed</span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div th:if="${allTransactions.isEmpty()}" class="text-center text-muted mt-4">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>No transactions found.</p>
            </div>
        </div>

        <div class="tab-pane fade" id="transfers" role="tabpanel">
            <h5>Transfers</h5>
            <p>Transfer funds between accounts or to external recipients.</p>
            <form>
                <div class="mb-3">
                    <label class="form-label">From Account</label>
                    <select class="form-select">
                        <option th:each="account : ${accounts}" th:value="${account.id}" th:text="${account.accountNumber}"></option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Transfer</button>
            </form>
        </div>
    </div>
</div>


<div class="bottom-nav" id="bottomNav">
    <a href="#" class="bottom-nav-item active" data-tab="account">
        <i class="fas fa-home"></i>
        <small>Home</small>
    </a>
    <a href="#" class="bottom-nav-item" data-tab="transactions">
        <i class="fas fa-history"></i>
        <small>History</small>
    </a>
    <a href="#" class="bottom-nav-item" data-tab="transfers">
        <i class="fas fa-exchange-alt"></i>
        <small>Transfers</small>
    </a>
</div>


<button class="fab" id="qrFab" title="Scan QR">
    <i class="fas fa-qrcode"></i>
</button>


<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
    <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="toastMessage"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>


<div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="scannerModalLabel">
                    <i class="fas fa-qrcode me-2"></i>Scan QR for Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex flex-column justify-content-center align-items-center">
                <div id="qr-reader-modal" class="qr-scanner mb-3"></div>
                <p id="qr-result-modal" class="text-muted mb-0">Point your camera at the QR code</p>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="paymentConfirmModal" tabindex="-1" aria-labelledby="paymentConfirmLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentConfirmLabel">
                    <i class="fas fa-credit-card me-2"></i>Confirm Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="confirmDetails">
                    <p><strong>Merchant:</strong> <span id="confirmMerchant"></span></p>
                    <p><strong>Amount:</strong> <span id="confirmAmount"></span></p>
                    <p><strong>Account to Debit:</strong> <span id="confirmAccount"></span></p>
                    <small class="text-muted">This will debit your account and credit the merchant.</small>
                </div>
                <div id="confirmError" class="alert alert-danger mt-2" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmPaymentBtn" class="btn btn-success">Confirm Payment</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-body text-center p-4">
                <i class="fas fa-check-circle text-success mb-3" style="font-size: 4rem;"></i>
                <h4 class="text-success mb-2">Payment Successful!</h4>
                <p class="text-muted mb-0">Your payment has been processed successfully.</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let html5QrCode;
    const qrReaderModal = document.getElementById('qr-reader-modal');
    const qrResultModal = document.getElementById('qr-result-modal');
    const scannerModal = new bootstrap.Modal(document.getElementById('scannerModal'), { backdrop: 'static', keyboard: false });
    const confirmModal = new bootstrap.Modal(document.getElementById('paymentConfirmModal'));
    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
    const confirmDetails = document.getElementById('confirmDetails');
    const confirmError = document.getElementById('confirmError');
    const confirmMerchant = document.getElementById('confirmMerchant');
    const confirmAmount = document.getElementById('confirmAmount');
    const confirmAccount = document.getElementById('confirmAccount');
    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');


    function showError(msg) {
        const toastEl = document.getElementById('errorToast');
        const toastBody = document.getElementById('toastMessage');
        toastBody.innerHTML = msg;
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }


    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.bottom-nav-item').forEach(item => {
            item.addEventListener('click', e => {
                e.preventDefault();
                document.querySelectorAll('.bottom-nav-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));
                item.classList.add('active');
                const targetTab = document.getElementById(item.dataset.tab);
                if (targetTab) {
                    targetTab.classList.add('show', 'active');
                }
            });
        });


        const qrTriggers = [document.getElementById('qrFab'), document.getElementById('scan-qr-desktop')];
        qrTriggers.forEach(trigger => {
            if (trigger) {
                trigger.addEventListener('click', e => {
                    e.preventDefault();
                    startScanner();
                });
            }
        });


        document.getElementById('scannerModal').addEventListener('hidden.bs.modal', stopScanning);
    });


    function checkSecureContext() {
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            showError('Camera access requires HTTPS. Switch to https:// and retry.');
            return false;
        }
        console.log('Secure context OK');
        return true;
    }

    async function startScanner() {
        if (typeof Html5Qrcode === 'undefined') {
            showError('QR scanner library failed to load');
            return;
        }
        if (!checkSecureContext()) return;

        html5QrCode = new Html5Qrcode("qr-reader-modal");
        qrResultModal.innerHTML = '<span class="success-msg"><i class="fas fa-spinner fa-spin me-1"></i>Starting camera...</span>';
        scannerModal.show();

        try {
            const camerasPromise = Html5Qrcode.getCameras();
            const timeoutPromise = new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Camera request timed out')), 10000)
            );
            const cameras = await Promise.race([camerasPromise, timeoutPromise]);
            console.log('Available cameras:', cameras);

            if (cameras.length === 0) {
                throw new Error('No cameras found');
            }

            let cameraId = cameras[0].id;
            const rearCamera = cameras.find(cam =>
                cam.label.toLowerCase().includes('back') || cam.label.toLowerCase().includes('rear') || cam.label.toLowerCase().includes('environment')
            );
            if (rearCamera) cameraId = rearCamera.id;

            console.log('Starting scan with camera ID:', cameraId);

            const config = { fps: 5, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
            await html5QrCode.start(cameraId, config, onScanSuccess, onScanFailure);

            qrResultModal.innerHTML = '<span class="text-muted"><i class="fas fa-camera me-1"></i>Point at QR code</span>';

        } catch (err) {
            console.error('Scanner start error:', err);
            let errorMessage = `Failed: ${err.message || err.name}`;
            if (err.name === 'NotAllowedError') {
                errorMessage = 'Permission denied. Check browser settings and retry.';
            } else if (err.name === 'NotFoundError') {
                errorMessage = 'No camera detected.';
            } else if (err.message.includes('secure') || !window.isSecureContext) {
                errorMessage = 'HTTPS required for camera.';
            } else if (err.message.includes('timeout')) {
                errorMessage = 'Camera request timed outâ€”check connection.';
            }
            showError(errorMessage);
            scannerModal.hide();
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log('QR Scan Success:', decodedText);
        stopScanning();
        scannerModal.hide();
        processQRScan(decodedText);
    }

    function onScanFailure(error) {
        if (!error.includes('No QR code found')) {
            console.log('Scan error:', error);
        }
    }

    async function stopScanning() {
        try {
            if (html5QrCode && html5QrCode.isScanning) {
                await html5QrCode.stop();
                console.log('Scanner stopped');
            }
        } catch (err) {
            console.error('Stop error:', err);
        }
        qrResultModal.innerHTML = '<span class="text-muted"><i class="fas fa-camera me-1"></i>Point at QR code</span>';
    }

    async function processQRScan(qrData) {
        console.log('Processing QR scan with data:', qrData);
        showError('<i class="fas fa-spinner fa-spin me-1"></i>Validating payment...');

        try {
            const response = await fetch('/dashboard/api/validate-qr', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                },
                body: JSON.stringify({ qrData: qrData })
            });

            const validationResult = await response.json();
            console.log('Validation result:', validationResult);

            if (!validationResult.valid) {
                const errorMsg = validationResult.error || 'Invalid QR data';
                let displayMsg;
                if (errorMsg === 'No account found') {
                    displayMsg = 'No account available for payment. Please contact support.';
                } else if (errorMsg === 'Insufficient balance') {
                    const requiredAmt = validationResult.requiredAmount || 0;
                    displayMsg = `Insufficient balance. Required: $${requiredAmt.toFixed(2)}.`;
                } else {
                    displayMsg = errorMsg;
                }
                showError(displayMsg);
                return;
            }


            confirmMerchant.textContent = validationResult.merchantName || 'Unknown Merchant';
            confirmAmount.textContent = `$${validationResult.amount.toFixed(2)} ${validationResult.currency}`;
            confirmAccount.textContent = `****${validationResult.payerAccountNumber.slice(-4)}`; // Masked account
            confirmError.style.display = 'none';
            confirmModal.show();

            confirmPaymentBtn.onclick = async () => {
                confirmPaymentBtn.disabled = true;
                confirmPaymentBtn.textContent = 'Processing...';
                confirmError.style.display = 'none';

                try {
                    const processResponse = await fetch('/dashboard/api/process-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                        },
                        body: JSON.stringify({
                            sessionId: validationResult.sessionId,
                            amount: validationResult.amount,
                            currency: validationResult.currency,
                            merchantId: validationResult.merchantId,
                            transactionRef: validationResult.transactionRef,
                            payerAccountId: validationResult.payerAccountId
                        })
                    });

                    const processResult = await processResponse.json();

                    if (!processResponse.ok || !processResult.success) {
                        throw new Error(processResult.error || `Payment failed: ${processResponse.statusText}`);
                    }

                    console.log('Payment result:', processResult);
                    confirmModal.hide();
                    successModal.show();
                    setTimeout(() => {
                        successModal.hide();
                        location.reload();
                    }, 3000);
                } catch (err) {
                    console.error('Payment error:', err);
                    confirmError.textContent = err.message;
                    confirmError.style.display = 'block';
                } finally {
                    confirmPaymentBtn.disabled = false;
                    confirmPaymentBtn.textContent = 'Confirm Payment';
                }
            };

        } catch (err) {
            console.error('QR processing error:', err);
            showError(`Network error: ${err.message}`);
        }
    }

    window.addEventListener('beforeunload', stopScanning);
</script>
</body>
</html>